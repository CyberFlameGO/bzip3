
CC=clang
CFLAGS=-O2 -march=native -mtune=native -flto -Iinclude -g3

.PHONY: all clean format install cloc

LIBBZ3_OBJECTS=obj/libsais.o obj/crc32.o obj/rle.o obj/cm.o \
               obj/libbz3.o obj/lzp.o

all: bzip3 bzip3.so

obj/%.o: src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

bzip3.so: $(LIBBZ3_OBJECTS)
	$(CC) -shared $(CFLAGS) -o $@ $^ @LIBS@

bzip3: obj/main.o $(LIBBZ3_OBJECTS)
	$(CC) $(CFLAGS) -o $@ $^ @LIBS@

clean:
	rm -f bzip3 obj/*.o

format:
	clang-format -i src/*.c include/*.h

install:
	@INSTALL@ -v -m 755 bzip3 @prefix@/bin
	@INSTALL@ -v -m 755 bzip3.so @prefix@/lib
	@INSTALL@ -v -m 755 include/libbz3.h @prefix@/include

cloc:
	cloc src/*.c include/*.h
